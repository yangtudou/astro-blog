---
// src/layouts/BaseLayout.astro
import Header from '../components/Header.astro'
import Footer from '../components/Footer.astro'
import BackToTop from '../components/BackToTop.astro'

export interface Props {
  title?: string
  description?: string
}

const { title = 'y3say', description } = Astro.props
---

<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="author" content="æ´‹å±±èŠ‹" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content={description || 'y3sayçš„ä¸ªäººåšå®¢'} />
    <link rel="icon" href="/favicon.svg" type="image/svg+xml" />
    <title>{title}</title>
    
    <script is:inline>
      ;(function () {
        const html = document.documentElement;
        
        // æ ¸å¿ƒé€»è¾‘ï¼šèŽ·å–æœ€ç»ˆåº”åº”ç”¨çš„çŠ¶æ€
        const getResolvedTheme = () => {
          const stored = localStorage.getItem('theme');
          const systemDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
          
          // å¦‚æžœæœ¬åœ°å­˜å‚¨æ˜¯ 'auto' æˆ–è€…æ ¹æœ¬æ²¡æœ‰å­˜å‚¨è¿‡ï¼Œç›´æŽ¥è¿”å›žç³»ç»Ÿåå¥½
          if (!stored || stored === 'auto') {
            return systemDark ? 'dark' : 'light';
          }
          
          // å¦‚æžœæœ‰æ‰‹åŠ¨é€‰æ‹©ï¼ˆdark/lightï¼‰ï¼Œåˆ™éµå¾ªæ‰‹åŠ¨é€‰æ‹©
          return stored;
        };

        const updateTheme = () => {
          const theme = getResolvedTheme();
          const isDark = theme === 'dark';
          html.classList.toggle('dark', isDark);
          
          // è§¦å‘äº‹ä»¶é€šçŸ¥ Logo ç­‰ç»„ä»¶
          window.dispatchEvent(new CustomEvent('theme-changed', { 
            detail: { theme, isDark } 
          }));
        };

        // 1. ç«‹å³åˆå§‹åŒ–
        updateTheme();

        // 2. ðŸ”‘ å…³é”®ï¼šå®žæ—¶ç›‘å¬è®¾å¤‡ç³»ç»Ÿæ·±è‰²æ¨¡å¼çš„å˜åŒ–
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e) => {
          // å½“ç³»ç»Ÿæ¨¡å¼åˆ‡æ¢æ—¶ï¼Œæˆ‘ä»¬è®¤ä¸ºç³»ç»Ÿåå¥½å…·æœ‰â€œå¼ºåˆ¶æ€§â€
          // æ­¤æ—¶æ¸…é™¤ localStorageï¼Œè®©ç½‘é¡µé‡æ–°å›žå½’â€œè·Ÿéšç³»ç»Ÿâ€çŠ¶æ€
          localStorage.removeItem('theme'); 
          updateTheme();
        });

        // 3. ç›‘å¬æ‰‹åŠ¨åˆ‡æ¢ï¼ˆé€‚é… ToggleTheme.astroï¼‰
        const observer = new MutationObserver((mutations) => {
          mutations.forEach((mutation) => {
            if (mutation.attributeName === 'class') {
              const isDark = html.classList.contains('dark');
              window.dispatchEvent(new CustomEvent('theme-changed', { 
                detail: { theme: isDark ? 'dark' : 'light', isDark } 
              }));
            }
          });
        });
        observer.observe(html, { attributes: true });
      })()
    </script>
  </head>

  <body class="font-sans text-gray-700 dark:text-gray-200 relative min-h-screen bg-white dark:bg-black transition-colors duration-500">
    <Header />
    <main class="mx-7 md:mx-auto md:max-w-3xl w-auto pb-10">
      <slot />
    </main>
    <Footer />
    <BackToTop />
  </body>
</html>