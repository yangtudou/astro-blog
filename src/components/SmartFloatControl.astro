---
// 删除了 Props 和 pageType 逻辑，使组件更轻量
---

<div id="float-controls" class="float-controls-container">
  <div class="left-action">
    <div class="buttons-capsule" id="main-island">
      <div class="specular-shine" id="specular"></div>
      
      <div class="expand-wrapper">
        <div class="expanded-content">
          <div class="inner-menu-list">
            <a href="/" class="menu-item"><span>首页</span><div class="i-ri-home-5-line"></div></a>
            <a href="/posts" class="menu-item"><span>文章</span><div class="i-ri-article-line"></div></a>
            <a href="/about" class="menu-item"><span>关于</span><div class="i-ri-user-3-line"></div></a>
            <a href="https://github.com/antfu" target="_blank" class="menu-item"><span>GitHub</span><div class="i-ri-github-line"></div></a>
          </div>
        </div>
      </div>

      <div class="capsule-dock" id="trigger-container">
        <button id="expand-trigger" class="island-btn-main" title="更多">
          <div class="i-ri-more-fill" id="more-icon"></div>
        </button>
      </div>
    </div>
  </div>

  <div class="right-action">
    <button id="to-top-trigger" class="round-btn visible-logic" title="回顶">
      <div class="i-ri-arrow-up-line"></div>
    </button>
  </div>
</div>

<script>
  function initLiquidLayout() {
    const island = document.getElementById('main-island');
    const triggerContainer = document.getElementById('trigger-container');
    const expandBtn = document.getElementById('expand-trigger');
    const toTopBtn = document.getElementById('to-top-trigger');
    const specular = document.getElementById('specular');
    const menuItems = document.querySelectorAll('.menu-item');

    if (!island || !expandBtn || !toTopBtn || !triggerContainer || !specular) return;

    let isExpanded = false;
    let mouseX = 0, mouseY = 0;
    let smoothX = 0, smoothY = 0;

    // 1. 物理引擎：光影位置插值 (YTAnimation 核心)
    window.addEventListener('mousemove', (e) => {
      mouseX = (e.clientX - window.innerWidth / 2) / (window.innerWidth / 2);
      mouseY = (e.clientY - window.innerHeight / 2) / (window.innerHeight / 2);
    });

    function render() {
      smoothX += (mouseX - smoothX) * 0.1;
      smoothY += (mouseY - smoothY) * 0.1;
      island!.style.transform = `perspective(1000px) rotateX(${-smoothY * 5}deg) rotateY(${smoothX * 5}deg)`;
      specular!.style.transform = `translate(${smoothX * 25}px, ${smoothY * 25}px)`;
      requestAnimationFrame(render);
    }
    render();

    // 2. 交互动效：弹开后隐藏三元点
    const toggleMenu = (expand: boolean) => {
      isExpanded = expand;
      island.classList.toggle('is-expanded', expand);
      
      triggerContainer.style.opacity = expand ? '0' : '1';
      triggerContainer.style.transform = expand ? 'scale(0.5) translateY(10px)' : 'scale(1) translateY(0)';
      triggerContainer.style.pointerEvents = expand ? 'none' : 'auto';

      menuItems.forEach((item, index) => {
        const el = item as HTMLElement;
        el.style.transitionDelay = expand ? `${index * 50 + 120}ms` : '0ms';
      });
    };

    expandBtn.onclick = (e) => {
      e.stopPropagation();
      toggleMenu(true);
    };

    document.addEventListener('click', (e) => {
      const target = e.target as Node;
      if (isExpanded && !island.contains(target)) {
        toggleMenu(false);
      }
    });

    toTopBtn.onclick = () => {
      window.scrollTo({ top: 0, behavior: 'smooth' });
    };

    window.addEventListener('scroll', () => {
      const show = window.scrollY > 300;
      document.querySelectorAll('.visible-logic').forEach(el => {
        el.classList.toggle('show', show);
      });
      if (isExpanded) toggleMenu(false);
    }, { passive: true });
  }

  document.addEventListener('astro:page-load', initLiquidLayout);
  initLiquidLayout();
</script>

<style>
  :root {
    --spring-ease: cubic-bezier(0.5, 1.7, 0.3, 0.8);
    --btn-size: 44px;
    --glass-bg: rgba(255, 255, 255, 0.25);
    --glass-border: rgba(255, 255, 255, 0.4);
    --text-color: #1d1d1f;
  }

  :global(.dark) {
    --glass-bg: rgba(20, 20, 22, 0.45);
    --glass-border: rgba(255, 255, 255, 0.1);
    --text-color: #f5f5f7;
  }

  .float-controls-container {
    position: fixed;
    inset: 0;
    pointer-events: none;
    z-index: 10000;
  }

  .left-action, .right-action {
    position: absolute;
    bottom: 1.5rem;
    pointer-events: auto;
  }

  .left-action { left: 1.5rem; }
  .right-action { right: 1.5rem; }

  /* ========== 液态功能岛 ========== */
  .buttons-capsule {
    position: relative;
    width: var(--btn-size);
    height: var(--btn-size);
    background: var(--glass-bg);
    backdrop-filter: blur(40px) saturate(210%);
    -webkit-backdrop-filter: blur(40px) saturate(210%);
    border: 0.5px solid var(--glass-border);
    border-radius: 50%;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.12);
    transition: 
      width 0.6s var(--spring-ease), 
      height 0.6s var(--spring-ease),
      border-radius 0.6s var(--spring-ease),
      transform 0.5s var(--spring-ease);
    overflow: hidden;
    transform-origin: bottom left;
  }

  .buttons-capsule.is-expanded {
    width: 150px;
    height: auto;
    border-radius: 24px;
    transform: scale(1.02) translateY(-5px);
  }

  .specular-shine {
    position: absolute;
    top: -50%; left: -50%; width: 200%; height: 200%;
    background: radial-gradient(circle at center, rgba(255, 255, 255, 0.4) 0%, transparent 35%);
    mix-blend-mode: overlay;
    pointer-events: none;
  }

  .expand-wrapper {
    display: grid;
    grid-template-rows: 0fr;
    transition: grid-template-rows 0.6s var(--spring-ease);
  }

  .is-expanded .expand-wrapper { grid-template-rows: 1fr; }

  .expanded-content { overflow: hidden; }

  .inner-menu-list {
    display: flex;
    flex-direction: column;
    gap: 0.4rem;
    padding: 0.8rem 0.6rem;
  }

  .menu-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0.6rem 0.8rem;
    color: var(--text-color);
    text-decoration: none;
    font-size: 0.85rem;
    font-weight: 600;
    border-radius: 14px;
    background: rgba(255, 255, 255, 0.05);
    transform: translateY(20px);
    opacity: 0;
    transition: transform 0.6s var(--spring-ease), opacity 0.4s ease;
  }

  .is-expanded .menu-item {
    transform: translateY(0);
    opacity: 1;
  }

  .capsule-dock {
    position: absolute;
    inset: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.4s var(--spring-ease);
  }

  .island-btn-main {
    width: 100%;
    height: 100%;
    border: none;
    background: transparent;
    cursor: pointer;
    color: var(--text-color);
    display: flex;
    align-items: center;
    justify-content: center;
  }

  /* ========== 右侧：回顶岛 ========== */
  .round-btn {
    width: var(--btn-size);
    height: var(--btn-size);
    border-radius: 50%;
    background: var(--glass-bg);
    backdrop-filter: blur(40px) saturate(210%);
    -webkit-backdrop-filter: blur(40px) saturate(210%);
    border: 0.5px solid var(--glass-border);
    color: var(--text-color);
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.12);
    transform: translateY(100px);
    opacity: 0;
    transition: all 0.6s var(--spring-ease);
  }

  .round-btn.show {
    transform: translateY(0);
    opacity: 1;
  }

  .round-btn:active { transform: scale(0.85); }

  @media (max-width: 768px) {
    :root { --btn-size: 40px; }
    .left-action { left: 1rem; }
    .right-action { right: 1rem; }
  }
</style>