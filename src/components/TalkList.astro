---
import { getCollection } from 'astro:content'
import { Image } from 'astro:assets'

const allTalksEntries = await getCollection('talk');
const allTalksList = allTalksEntries
  .flatMap(entry => entry.data)
  .filter(item => !item.draft)
  .sort((a, b) => new Date(b.publishDate).getTime() - new Date(a.publishDate).getTime());

function formatDate(date: Date | string) {
  const d = new Date(date);
  return `${d.getFullYear()}.${(d.getMonth() + 1).toString().padStart(2, '0')}.${d.getDate().toString().padStart(2, '0')}`;
}
---

<section class="w-full py-6 px-4 sm:py-12 sm:px-6">
  <div class="max-w-md mx-auto sm:max-w-2xl md:max-w-5xl xl:max-w-7xl grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-6 sm:gap-10">
    {allTalksList.map((talk) => (
      <article class="relative w-full aspect-[3/4] overflow-hidden rounded-lg border border-stone-200 dark:border-stone-700">
        {talk.cover && (
          <div class="absolute inset-0 bg-stone-200 dark:bg-stone-800">
            <Image
              src={talk.cover}
              alt={talk.title}
              width={600}
              height={800}
              class="w-full h-full object-cover"
            />
          </div>
        )}

        <div
          class="absolute inset-0 bg-gradient-to-t from-black/88 via-black/25 to-transparent dark:from-black/92 dark:via-black/35"
          aria-hidden
        />

        {talk.excerpt && (
          <div class="absolute inset-0 flex flex-col px-4 sm:px-5 xl:px-6 pt-12 sm:pt-14 pb-12 sm:pb-14 text-white">
            <div class="flex-1 min-h-0 overflow-hidden flex flex-col justify-end">
              <p
                class={`w-full max-w-[24em] sm:max-w-[26em]
                /* 移动端保持原样，桌面端(xl)调小字号与行高 */
                text-[15px] sm:text-[17px] xl:text-[14px] 
                leading-[2.15] sm:leading-[2.25] xl:leading-[1.8]
                tracking-[0.04em] sm:tracking-[0.06em]
                text-white/98
                whitespace-pre-line break-words
                [font-family:'Noto Serif SC','Source Han Serif SC','Source Han Serif CN','STSong',serif]
                [text-shadow:0_1px_4px_rgba(0,0,0,0.7),0_0_20px_rgba(0,0,0,0.3)]
                ${talk.align === 'center'
                  ? 'text-center mx-auto [text-align-last:center]'
                  : 'text-left [text-align:justify] [text-align-last:left]'
                }`}
              >
                {talk.excerpt}
              </p>
            </div>
          </div>
        )}

        <h2 class="absolute bottom-3 left-4 sm:bottom-4 sm:left-5 text-[10px] sm:text-[11px] font-light tracking-[0.18em] text-white/70 truncate max-w-[45%] [text-shadow:0_1px_2px_rgba(0,0,0,0.8)]">
          {talk.title}
        </h2>

        <time
          class="absolute bottom-3 right-4 sm:bottom-4 sm:right-5
            text-[10px] sm:text-[11px] font-mono tracking-[0.2em]
            text-white/70 [text-shadow:0_1px_2px_rgba(0,0,0,0.8)]"
          datetime={new Date(talk.publishDate).toISOString().slice(0, 10)}
        >
          {formatDate(talk.publishDate)}
        </time>
      </article>
    ))}
  </div>
</section>