---
import { getCollection } from 'astro:content'
import { Image } from 'astro:assets'

const allTalksEntries = await getCollection('talk');
const allTalksList = allTalksEntries
  .flatMap(entry => entry.data)
  .filter(item => !item.draft)
  .sort((a, b) => new Date(b.publishDate).getTime() - new Date(a.publishDate).getTime());

function formatDate(date: Date | string) {
  const d = new Date(date);
  return `${d.getFullYear().toString().slice(-2)} ${(d.getMonth() + 1).toString().padStart(2, '0')} ${d.getDate().toString().padStart(2, '0')}`;
}
---

<div class="w-full py-12">
  <div class="max-w-1600px mx-auto xl:columns-4 lg:columns-3 md:columns-2 columns-1 gap-10 space-y-10">
    {allTalksList.map((talk) => (
      <article class="break-inside-avoid mb-10 relative group overflow-hidden bg-[#0a0a0a]">
        
        <Image 
          src={talk.cover} 
          alt={talk.title} 
          width={600} 
          class="w-full h-auto block opacity-90 md:group-hover:opacity-100 transition-all duration-1000 md:group-hover:scale-105" 
        />

        <div class="absolute inset-0 flex flex-col justify-end px-5 pb-4 bg-gradient-to-t from-black/90 via-black/20 to-transparent">
          <div class="flex flex-col w-full">
            {talk.excerpt && (
              <p class="content-serif text-[15px] md:text-[13px] leading-[1.7] md:leading-[1.8] text-white/95 whitespace-pre-line tracking-wide mb-3 [text-shadow:0_1px_5px_rgba(0,0,0,0.9)] 
                /* 核心解决方案： */
                text-justify-chinese 
                break-all 
                text-align-last-left">
                {talk.excerpt}
              </p>
            )}

            <div class="flex justify-between items-end opacity-60 md:opacity-20 md:group-hover:opacity-60 transition-opacity duration-700">
              <h2 class="text-[10px] md:text-[7.5px] font-300 tracking-[0.2em] uppercase text-white/70 truncate mr-4">
                {talk.title}
              </h2>
              <span class="font-mono text-[10px] md:text-[7.5px] tracking-[0.1em] text-white/50 whitespace-nowrap">
                {formatDate(talk.publishDate)}
              </span>
            </div>
          </div>
        </div>
      </article>
    ))}
  </div>
</div>

<style>
  .content-serif {
    font-family: "Noto Serif SC", "Source Han Serif SC", "Source Han Serif CN", "STSong", serif;
    font-weight: 400;
    
    /* 1. 解决中文排版的利器：两端对齐 */
    text-align: justify;
    
    /* 2. 避免最后一行只有一个字（如果浏览器支持） */
    text-wrap: pretty;
    
    /* 3. 严格遵循中文避头尾法则（不让标点出现在行首） */
    line-break: strict;
    word-break: break-all;
  }

  /* ... 其余样式不变 */
</style>