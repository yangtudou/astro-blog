---
import { getCollection } from 'astro:content'
import type { CollectionEntry } from 'astro:content'

// 定义 Props 接口
export interface Props {
  posts?: CollectionEntry<'post'>[]
}

const { posts: propPosts = [] } = Astro.props

// 获取所有文章
const allPosts = await getCollection('post')

// 过滤和转换文章数据
const filteredPosts = allPosts
  .filter(post => {
    // 过滤掉草稿
    if (post.data.draft) return false
    return true
  })
  .map(post => ({
    id: post.id,
    slug: post.slug,
    title: post.data.title,
    date: post.data.publishDate,
  }))

// 合并文章列表
const allPostsList = [...propPosts, ...filteredPosts]
  .sort((a, b) => new Date(b.date).getTime() - new Date(a.date).getTime())

// 工具函数
function formatDate(date: Date | string) {
  const d = new Date(date)
  const currentYear = new Date().getFullYear()
  const postYear = d.getFullYear()
  
  // 如果是当前年份，只显示月份和日期
  if (postYear === currentYear) {
    return `${(d.getMonth() + 1).toString().padStart(2, '0')}-${d.getDate().toString().padStart(2, '0')}`
  }
  
  // 对于往年文章，显示完整日期
  return `${d.getFullYear()}-${(d.getMonth() + 1).toString().padStart(2, '0')}-${d.getDate().toString().padStart(2, '0')}`
}

function getYear(date: Date | string) {
  return new Date(date).getFullYear()
}

function isFuture(date?: Date | string) {
  return date && new Date(date) > new Date()
}

function isSameYear(a?: Date | string, b?: Date | string) {
  return a && b && getYear(a) === getYear(b)
}

function isSameGroup(a: any, b?: any) {
  return (isFuture(a.date) === isFuture(b?.date)) && isSameYear(a.date, b?.date)
}

function getGroupName(post: any) {
  if (isFuture(post.date)) return '即将推出...'
  return getYear(post.date)
}
---


<ul class="list-none p-0 m-0">
  {allPostsList.length === 0 ? (
    <div class="py-2 opacity-50">这里还什么都没有</div>
  ) : (
    allPostsList.map((post, idx) => {
      const showGroup = !isSameGroup(post, allPostsList[idx - 1])
      const href = `/post/${post.slug}`
      
      return (
        <>
          {showGroup && (
            <div 
              class="select-none relative h-20 pointer-events-none"
              style={`
                --enter-stage: ${idx - 2};
                --enter-step: 60ms;
              `}
            >
              <span class="text-8rem absolute text-black:3 dark:text-white:3 top--2rem font-bold z--1">
                {getGroupName(post)}
              </span>
            </div>
          )}
          
          <div
            class="slide-enter"
            style={`
              --enter-stage: ${idx};
              --enter-step: 60ms;
            `}
          >
            <a 
              href={href}
              class="block font-normal mb-6 mt-2"
            >
              <li class="no-underline flex flex-col md:flex-row gap-2 md:items-center">
                <div class="title text-lg leading-1.2em flex gap-2 flex-wrap">
                  <span class="align-middle">{post.title}</span>
                </div>
                
                <div class="flex gap-2 items-center">
                  <span class="text-sm opacity-50 whitespace-nowrap">
                    {formatDate(post.date)}
                  </span>
                </div>
              </li>
            </a>
          </div>
        </>
      )
    })
  )}
</ul>