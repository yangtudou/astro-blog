---
// src/components/Plum.astro
---

<div
  class="plum-container fixed inset-0 pointer-events-none print:hidden z--1"
  style="mask-image: radial-gradient(circle, transparent, black); -webkit-mask-image: radial-gradient(circle, transparent, black);"
>
  <canvas id="plum-canvas"></canvas>
</div>

<script>
  const r180 = Math.PI
  const r90 = Math.PI / 2
  const r15 = Math.PI / 12
  const COLOR = '#88888825'
  
  // ğŸ”‘ ç§»åŠ¨ç«¯ä¸“ç”¨é…ç½®
  const isMobile = window.innerWidth < 768
  const MIN_BRANCH = isMobile ? 5 : 30  // ç§»åŠ¨ç«¯åªæœ‰ 5 å±‚
  const MAX_BRANCH = isMobile ? 20 : 100  // ç§»åŠ¨ç«¯æœ€å¤š 20 ä¸ªåˆ†æ”¯

  let steps = []
  let prevSteps = []
  let lastTime = performance.now()
  const interval = isMobile ? 1000 / 20 : 1000 / 40  // ç§»åŠ¨ç«¯é™åˆ° 20fps

  function init() {
    const canvas = document.getElementById('plum-canvas')
    if (!canvas || !(canvas instanceof HTMLCanvasElement)) return
    
    const ctx = canvas.getContext('2d')
    if (!ctx) return

    const dpr = window.devicePixelRatio || 1
    canvas.style.width = `${window.innerWidth}px`
    canvas.style.height = `${window.innerHeight}px`
    canvas.width = dpr * window.innerWidth
    canvas.height = dpr * window.innerHeight
    ctx.scale(dpr, dpr)

    const random = Math.random

    const polar2cart = (x = 0, y = 0, r = 0, theta = 0) => [
      x + r * Math.cos(theta),
      y + r * Math.sin(theta)
    ]

    // ğŸ”‘ åˆ†æ”¯è®¡æ•°å™¨ï¼ˆå…¨å±€ï¼‰
    let totalBranches = 0

    const step = (x, y, rad, counter = { value: 0 }) => {
      // ğŸ”‘ è¾¾åˆ°æœ€å¤§åˆ†æ”¯æ•°ç«‹å³åœæ­¢
      if (totalBranches >= MAX_BRANCH) return
      
      const length = random() * 6
      counter.value += 1
      totalBranches += 1

      const [nx, ny] = polar2cart(x, y, length, rad)

      ctx.beginPath()
      ctx.moveTo(x, y)
      ctx.lineTo(nx, ny)
      ctx.stroke()

      const rad1 = rad + random() * r15
      const rad2 = rad - random() * r15

      if (nx < -100 || nx > window.innerWidth + 100 || ny < -100 || ny > window.innerHeight + 100)
        return

      // ğŸ”‘ ç§»åŠ¨ç«¯å¤§å¹…é™ä½åˆ†æ”¯æ¦‚ç‡
      const rate = counter.value <= MIN_BRANCH 
        ? (isMobile ? 0.3 : 0.8)  // ç§»åŠ¨ç«¯ 0.3ï¼Œæ¡Œé¢ç«¯ 0.8
        : (isMobile ? 0.1 : 0.5)  // ç§»åŠ¨ç«¯ 0.1ï¼Œæ¡Œé¢ç«¯ 0.5

      if (random() < rate) steps.push(() => step(nx, ny, rad1, counter))
      if (random() < rate) steps.push(() => step(nx, ny, rad2, counter))
    }

    const frame = () => {
      if (performance.now() - lastTime < interval) {
        window.plumAnimationId = requestAnimationFrame(frame)
        return
      }

      lastTime = performance.now()
      prevSteps = steps
      steps = []

      if (!prevSteps.length) {
        window.plumAnimationId = null
        return
      }

      prevSteps.forEach((i) => {
        // ğŸ”‘ ç§»åŠ¨ç«¯å¿«é€Ÿå®Œæˆï¼Œä¸å»¶è¿Ÿ
        if (isMobile || random() < 0.3) {
          i()
        } else {
          steps.push(i)
        }
      })

      window.plumAnimationId = requestAnimationFrame(frame)
    }

    const start = () => {
      if (window.plumAnimationId) {
        cancelAnimationFrame(window.plumAnimationId)
        window.plumAnimationId = null
      }

      totalBranches = 0  // ğŸ”‘ é‡ç½®è®¡æ•°å™¨
      ctx.clearRect(0, 0, canvas.width, canvas.height)
      ctx.lineWidth = 1
      ctx.strokeStyle = COLOR
      prevSteps = []
      
      const randomMiddle = () => random() * 0.6 + 0.2
      
      // ğŸ”‘ ç§»åŠ¨ç«¯åªä»é¡¶éƒ¨ç”Ÿé•¿ä¸€ä¸ªåˆ†æ”¯
      if (isMobile) {
        steps = [
          () => step(randomMiddle() * window.innerWidth, -5, r90),
        ]
      } else {
        steps = [
          () => step(randomMiddle() * window.innerWidth, -5, r90),
          () => step(randomMiddle() * window.innerWidth, window.innerHeight + 5, -r90),
          () => step(-5, randomMiddle() * window.innerHeight, 0),
          () => step(window.innerWidth + 5, randomMiddle() * window.innerHeight, r180),
        ]
      }
      
      window.plumAnimationId = requestAnimationFrame(frame)
    }

    start()
  }

  window.initPlum = init
  init()

  // ğŸ”‘ ç§»åŠ¨ç«¯å®Œå…¨ç¦ç”¨ resize é‡ç»˜
  if (!isMobile) {
    let resizeTimer
    let lastWidth = window.innerWidth
    let lastHeight = window.innerHeight
    
    window.addEventListener('resize', () => {
      clearTimeout(resizeTimer)
      resizeTimer = setTimeout(() => {
        const currentWidth = window.innerWidth
        const currentHeight = window.innerHeight
        
        if (Math.abs(currentWidth - lastWidth) > 50 || Math.abs(currentHeight - lastHeight) > 50) {
          lastWidth = currentWidth
          lastHeight = currentHeight
          init()
        }
      }, 500)
    })
  }
</script>

<style>
  .plum-container {
    opacity: 0.5;
  }
</style>