---
/**
 * 通用图片画廊组件
 * 支持点击图片弹出大图预览，具备模糊背景和缩放动画
 */
interface Props {
  // 允许自定义需要监听图片的父级容器选择器，默认为常见文章和图片容器
  selector?: string;
}

const { selector = '.markdown-content, .talk-image, .image-container' } = Astro.props;
---

<div id="lightbox-overlay" class="lightbox-hidden" aria-hidden="true">
  <div class="lightbox-wrapper">
    <img id="lightbox-image" src="" alt="图片预览" />
  </div>
</div>

<script define:vars={{ selector }}>
  function initGallery() {
    const overlay = document.getElementById('lightbox-overlay');
    const lightboxImg = document.getElementById('lightbox-image');

    if (!overlay || !lightboxImg) return;

    const handleImageClick = (e) => {
      const target = e.target;
      
      // 1. 检查是否是图片
      if (!(target instanceof HTMLImageElement)) return;
      
      // 2. 检查图片是否在指定的通用选择器容器内
      const isGalleryImg = target.closest(selector);
      
      // 3. 过滤掉过小的图片（如图标）和占位图
      if (isGalleryImg && target.naturalWidth > 150) {
        e.preventDefault();
        
        lightboxImg.src = target.src;
        lightboxImg.alt = target.alt || '预览图片';
        
        overlay.classList.remove('lightbox-hidden');
        overlay.classList.add('lightbox-visible');
        overlay.setAttribute('aria-hidden', 'false');
        document.body.style.overflow = 'hidden'; // 禁止背景滚动
      }
    };

    const closeLightbox = () => {
      overlay.classList.remove('lightbox-visible');
      overlay.classList.add('lightbox-hidden');
      overlay.setAttribute('aria-hidden', 'true');
      document.body.style.overflow = '';
      setTimeout(() => { lightboxImg.src = ''; }, 300); // 清理资源
    };

    // 使用事件委托，提高性能且支持动态加载的内容
    document.addEventListener('click', handleImageClick);
    overlay.addEventListener('click', closeLightbox);

    // 支持 ESC 键关闭
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && overlay.classList.contains('lightbox-visible')) {
        closeLightbox();
      }
    });
  }

  // 适配 Astro 的页面平滑转换
  document.addEventListener('astro:page-load', initGallery);
  // 初次加载初始化
  initGallery();
</script>

<style is:global>
  :root {
    --lightbox-bg: rgba(255, 255, 255, 0.85);
    --lightbox-blur: 20px;
  }

  html.dark :root {
    --lightbox-bg: rgba(10, 10, 10, 0.85);
  }

  #lightbox-overlay {
    position: fixed;
    inset: 0;
    z-index: 9999;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: zoom-out;
    background: var(--lightbox-bg);
    backdrop-filter: blur(var(--lightbox-blur)) saturate(180%);
    -webkit-backdrop-filter: blur(var(--lightbox-blur)) saturate(180%);
    transition: opacity 0.4s cubic-bezier(0.4, 0, 0.2, 1), visibility 0.4s;
  }

  .lightbox-hidden {
    visibility: hidden;
    opacity: 0;
    pointer-events: none;
  }

  .lightbox-visible {
    visibility: visible;
    opacity: 1;
    pointer-events: auto;
  }

  #lightbox-image {
    max-width: 90vw;
    max-height: 85vh;
    object-fit: contain;
    border-radius: 8px;
    box-shadow: 0 20px 50px rgba(0,0,0,0.15);
    transform: scale(0.95);
    transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
  }

  .lightbox-visible #lightbox-image {
    transform: scale(1);
  }

  /* 移动端优化 */
  @media (max-width: 768px) {
    #lightbox-image {
      max-width: 95vw;
      border-radius: 4px;
    }
  }
</style>