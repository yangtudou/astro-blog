---
interface Props {
  selector?: string;
}

const { selector = '.talk-image-box' } = Astro.props;
---

<div id="lightbox-overlay" class="lightbox-hidden" aria-hidden="true">
  <div class="lightbox-wrapper" id="lightbox-wrapper">
    <div id="lightbox-loader" class="loader-hidden"></div>
    <img id="lightbox-image" src="" alt="é¢„è§ˆå›¾ç‰‡" />
  </div>
</div>

<script define:vars={{ selector }}>
  function initGallery() {
    const overlay = document.getElementById('lightbox-overlay');
    const lightboxImg = document.getElementById('lightbox-image');
    const wrapper = document.getElementById('lightbox-wrapper');

    if (!overlay || !lightboxImg) return;

    let currentIndex = -1;
    let galleryImages = [];
    let lastActiveImg = null;
    let isAnimating = false;

    // ðŸ”‘ é”å®šèƒŒæ™¯æ»šåŠ¨
    const lockScroll = () => {
      document.documentElement.style.overflow = 'hidden';
      document.body.style.overflow = 'hidden';
      document.body.style.touchAction = 'none';
    };

    const unlockScroll = () => {
      document.documentElement.style.overflow = '';
      document.body.style.overflow = '';
      document.body.style.touchAction = '';
    };

    const updateGallery = () => {
      const allImgs = Array.from(document.querySelectorAll(`${selector} img`));
      galleryImages = allImgs.filter(img => img.naturalWidth > 150);
    };

    // ðŸ”‘ è®¡ç®—ä»ŽåŽŸä½å¼¹å‡ºçš„æžœå†»åŠ¨ç”»
    const animateFromRect = (rect, targetImg) => {
      const scale = rect.width / (window.innerWidth * 0.85);
      const translateX = (rect.left + rect.width / 2) - window.innerWidth / 2;
      const translateY = (rect.top + rect.height / 2) - window.innerHeight / 2;

      // åˆå§‹ä½ç½®è®¾å®šåœ¨ç¼©ç•¥å›¾å¤„
      lightboxImg.style.transition = 'none';
      lightboxImg.style.transform = `translate(${translateX}px, ${translateY}px) scale(${scale})`;
      lightboxImg.style.opacity = '0';

      requestAnimationFrame(() => {
        requestAnimationFrame(() => {
          // ðŸ”‘ æ¨¡æ‹Ÿ iOS çš„å¼¹æ€§ Bezierï¼šå¿«é€Ÿå†²å‡ºï¼Œå¸¦æœ‰å¾®å¼±å›žå¼¹æ„Ÿ
          lightboxImg.style.transition = 'transform 0.7s cubic-bezier(0.2, 1.2, 0.2, 1), opacity 0.4s ease';
          lightboxImg.style.transform = 'translate(0, 0) scale(1)';
          lightboxImg.style.opacity = '1';
        });
      });
    };

    const showImage = (index, direction = 0) => {
      if (isAnimating || index < 0 || index >= galleryImages.length) return;
      isAnimating = true;
      
      const prevIndex = currentIndex;
      currentIndex = index;
      lastActiveImg = galleryImages[index];

      if (prevIndex === -1) {
        // ç¬¬ä¸€æ¬¡æ‰“å¼€ï¼šä»Žä½ç½®å¼¹å‡º
        lightboxImg.src = lastActiveImg.src;
        animateFromRect(lastActiveImg.getBoundingClientRect());
        setTimeout(() => isAnimating = false, 700);
      } else {
        // ðŸ”‘ åˆ‡æ¢æ—¶çš„æžœå†»æ„Ÿï¼šæ—§å›¾æ»‘å‡ºï¼Œæ–°å›¾å¼¹æ€§æ»‘å…¥
        const offset = direction * 50;
        lightboxImg.style.transition = 'transform 0.4s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.3s ease';
        lightboxImg.style.transform = `translateX(${-offset}px) scale(0.95)`;
        lightboxImg.style.opacity = '0';

        setTimeout(() => {
          lightboxImg.src = lastActiveImg.src;
          lightboxImg.style.transition = 'none';
          lightboxImg.style.transform = `translateX(${offset}px) scale(0.95)`;
          
          requestAnimationFrame(() => {
            requestAnimationFrame(() => {
              lightboxImg.style.transition = 'transform 0.6s cubic-bezier(0.2, 1.2, 0.2, 1), opacity 0.4s ease';
              lightboxImg.style.transform = 'translateX(0) scale(1)';
              lightboxImg.style.opacity = '1';
              setTimeout(() => isAnimating = false, 600);
            });
          });
        }, 300);
      }
    };

    const close = () => {
      if (!lastActiveImg) return;
      const rect = lastActiveImg.getBoundingClientRect();
      const scale = rect.width / (window.innerWidth * 0.85);
      const translateX = (rect.left + rect.width / 2) - window.innerWidth / 2;
      const translateY = (rect.top + rect.height / 2) - window.innerHeight / 2;

      lightboxImg.style.transition = 'transform 0.5s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.4s ease';
      lightboxImg.style.transform = `translate(${translateX}px, ${translateY}px) scale(${scale})`;
      lightboxImg.style.opacity = '0';
      overlay.style.opacity = '0';

      setTimeout(() => {
        overlay.classList.replace('lightbox-visible', 'lightbox-hidden');
        overlay.style.opacity = '';
        unlockScroll();
        currentIndex = -1;
      }, 500);
    };

    // ðŸ”‘ æ»šè½®ä¸Žæ‰‹åŠ¿ç›‘å¬
    overlay.addEventListener('wheel', (e) => {
      e.preventDefault();
      if (isAnimating) return;
      if (Math.abs(e.deltaX) > 30 || Math.abs(e.deltaY) > 30) {
        showImage(currentIndex + (e.deltaX > 0 || e.deltaY > 0 ? 1 : -1), e.deltaX > 0 || e.deltaY > 0 ? 1 : -1);
      }
    }, { passive: false });

    let startX = 0;
    overlay.addEventListener('touchstart', e => startX = e.touches[0].clientX, {passive: true});
    overlay.addEventListener('touchend', e => {
      const diff = e.changedTouches[0].clientX - startX;
      if (Math.abs(diff) > 60) {
        showImage(currentIndex + (diff > 0 ? -1 : 1), diff > 0 ? -1 : 1);
      } else if (Math.abs(diff) < 5) {
        close();
      }
    }, {passive: true});

    overlay.onclick = (e) => { if(e.pointerType === 'mouse') close(); };

    document.addEventListener('click', (e) => {
      const target = e.target;
      if (target instanceof HTMLImageElement && target.closest(selector)) {
        updateGallery();
        const index = galleryImages.indexOf(target);
        if (index !== -1) {
          overlay.classList.replace('lightbox-hidden', 'lightbox-visible');
          lockScroll();
          showImage(index);
        }
      }
    });
  }

  document.addEventListener('astro:page-load', initGallery);
  initGallery();
</script>

<style is:global>
  #lightbox-overlay {
    position: fixed;
    inset: 0;
    z-index: 9999;
    display: flex;
    align-items: center;
    justify-content: center;
    background: rgba(255, 255, 255, 0.1);
    backdrop-filter: blur(50px) saturate(100%);
    -webkit-backdrop-filter: blur(50px) saturate(100%);
    transition: opacity 0.4s ease;
    touch-action: none;
    cursor: zoom-out;
  }

  .lightbox-hidden { visibility: hidden; opacity: 0; pointer-events: none; }
  .lightbox-visible { visibility: visible; opacity: 1; pointer-events: auto; }

  .lightbox-wrapper {
    width: 85vw;
    height: 85vh;
    display: flex;
    justify-content: center;
    align-items: center;
    pointer-events: none;
  }

  #lightbox-image {
    max-width: 100%;
    max-height: 100%;
    object-fit: contain;
    border-radius: 4px;
    /* ðŸ”‘ æŸ”å’Œçš„é˜´å½±ï¼Œå¢žåŠ æ‚¬æµ®æ„Ÿ */
    box-shadow: 0 40px 100px rgba(0,0,0,0.5);
    will-change: transform, opacity;
  }

  .loader-hidden { display: none; }
</style>